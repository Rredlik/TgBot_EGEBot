import asyncio

from aiogram import Dispatcher, Bot
from aiogram.dispatcher import FSMContext
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, Message, CallbackQuery, ContentType
from aiogram.utils import exceptions
from loguru import logger

from database.methods.other import parseAllUsers
from filters.main import IsAdmin
from handlers.admin.media import _register_media_handlers
from handlers.keyboards import kb_main
from utils.states import ADPosting


async def __admin_menu(msg: Message, state: FSMContext):
    userId = msg.from_user.id
    message_txt = '–ú–µ–Ω—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n' \
                  '- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ\n' \
                  '- –†–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
    markup = InlineKeyboardMarkup() \
        .add(InlineKeyboardButton('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', callback_data='analytic')) \
        .add(InlineKeyboardButton('–†–∞—Å—Å—ã–ª–∫–∞', callback_data='adPosting'))

    await msg.bot.send_message(userId, message_txt, reply_markup=markup)
    logger.info(f'User_id: {userId}')


# endregion

# region Advertising

async def __write_AdPost(query: CallbackQuery, state: FSMContext):
    await state.reset_state()
    text = 'üì∑ –§–æ—Ç–æ: –≤—ã–±–µ—Ä–∏ –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞\n' \
                  'üé• –í–∏–¥–µ–æ: –≤—ã–±–µ—Ä–∏ –æ–¥–Ω–æ –≤–∏–¥–µ–æ –∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞\n\n' \
                  '–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞:\n' \
                  '&lt;a href="—Å—Å—ã–ª–∫–∞"&gt;—Ç–µ–∫—Å—Ç —Å —Å—ã–ª–∫–æ–π&lt;/a&gt;\n' \
                  '&lt;b&gt;<b>–ü–æ–ª—É–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b>&lt;/b&gt;\n' \
                  '&lt;i&gt;<i>–¢–µ–∫—Å—Ç –∫—É—Ä—Å–∏–≤</i>&lt;/i&gt;\n\n' \
                  '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏, –ª–∏–±–æ –Ω–∞–∂–º–∏—Ç–µ –æ—Ç–º–µ–Ω–∞\n\n'
    markup = InlineKeyboardMarkup() \
        .add(InlineKeyboardButton('–û—Ç–º–µ–Ω–∞', callback_data='close_menu_'))

    await query.bot.send_message(query.from_user.id, text, reply_markup=markup)
    await ADPosting.WriteText.set()


async def __check_AdPost(msg: Message, state: FSMContext, image=None, video=None):
    bot: Bot = msg.bot
    userId = msg.from_user.id
    await ADPosting.CheckPost.set()
    addText = '\n\n‚¨Ü‚¨Ü‚¨Ü\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", –µ—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ, –∏–Ω–∞—á–µ –Ω–∞–∂–º–∏—Ç–µ "–ò—Å–ø—Ä–∞–≤–∏—Ç—å"'
    markup = InlineKeyboardMarkup() \
        .add(InlineKeyboardButton('–û—Ç–ø—Ä–∞–≤–∏—Ç—å', callback_data='sendAdPost')) \
        .add(InlineKeyboardButton('–ò—Å–ø—Ä–∞–≤–∏—Ç—å', callback_data='adPosting'))

    if msg.content_type == ContentType.PHOTO:
        image = msg.photo[0].file_id
        msgText = msg.caption if msg.caption else ''
        await bot.send_photo(userId, image, msgText + addText, reply_markup=markup)
    elif msg.content_type == ContentType.VIDEO:
        video = msg.video.file_id
        msgText = msg.caption if msg.caption else ''
        await bot.send_video(userId, video, msgText + addText, reply_markup=markup)
    else:
        msgText = msg.text
        await bot.send_message(userId, msgText + addText, reply_markup=markup)

    async with state.proxy() as data:
        data['msgText'] = msgText
        data['imageId'] = image
        data['videoId'] = video
    await ADPosting.SendPost.set()


async def __send_AdPost(query: CallbackQuery, state: FSMContext):
    bot: Bot = query.bot
    dataS = await state.get_data()
    print(f'dataS: {dataS}')
    async with state.proxy() as data:
        msgText = data['msgText']
        image = data['imageId']
        video = data['videoId']
    await state.reset_state()
    await bot.send_message(query.from_user.id, '–†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∞—Ç–∞‚úÖ', reply_markup=await kb_main())
    count = await broadcaster(bot, msgText, image, video)
    await bot.send_message(query.from_user.id, f'{count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ', reply_markup=await kb_main())


async def broadcaster(bot, msgText, image, video) -> int:
    """
    Simple broadcaster
    :return: Count of messages
    """
    allUsers = await parseAllUsers()

    count = 0
    try:
        for user_id in allUsers:
            if await send_message(bot, user_id[0], text=msgText, image=image, video=video):
                count += 1
            await asyncio.sleep(.05)  # 20 messages per second (Limit: 30 messages per second)
    finally:
        logger.success(f'–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º - {count}')
    return count


async def send_message(bot, user_id: int, text: str, disable_notification: bool = False, image=False,
                       video=False) -> bool:
    """
    Safe messages sender
    """
    try:
        if image:
            await bot.send_photo(chat_id=user_id, photo=image, caption=text, reply_markup=await kb_main(),
                                 disable_notification=disable_notification)
        elif video:
            await bot.send_video(chat_id=user_id, video=video, caption=text, reply_markup=await kb_main(),
                                 disable_notification=disable_notification)
        else:
            await bot.send_message(chat_id=user_id, text=text, reply_markup=await kb_main(),
                                   disable_notification=disable_notification)

    except exceptions.RetryAfter as e:
        logger.error(f"Target [ID:{user_id}]: Flood limit is exceeded. Sleep {e.timeout} seconds.")
        await asyncio.sleep(e.timeout)
        return await send_message(bot, user_id, text, disable_notification, image, video)  # Recursive call
    except Exception as er:
        logger.error(f"Target [ID:{user_id}]: {er}")
    else:
        return True
    return False


# endregion
######################################################
######################################################
# region Analytics

async def __analytic(query: CallbackQuery, state: FSMContext) -> None:
    users_count = await parseAllUsers()
    text = (
        '–û—Ç—á–µ—Ç:\n',
        f'–ö–æ–ª-–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(users_count)}'
    )
    await query.answer('\n'.join(text), show_alert=True, cache_time=0)


def register_admin_handlers(dp: Dispatcher) -> None:
    dp.register_message_handler(__admin_menu, IsAdmin(), commands=['admin'],
                                state='*')
    # endregion

    # region Advertising
    dp.register_callback_query_handler(__write_AdPost, lambda c: c.data == 'adPosting',
                                       IsAdmin(), state='*')
    dp.register_message_handler(__check_AdPost, IsAdmin(), state=ADPosting.WriteText,
                                content_types=[ContentType.PHOTO, ContentType.VIDEO, ContentType.TEXT])
    dp.register_callback_query_handler(__send_AdPost, lambda c: c.data == 'sendAdPost',
                                       IsAdmin(), state=ADPosting.SendPost)
    # endregion

    # region Analytics
    dp.register_callback_query_handler(__analytic, lambda c: c.data == 'analytic',
                                       IsAdmin(), state='*')
    _register_media_handlers(dp)
    # endregion
